# User-Role Management Service

gRPC-—Å–µ—Ä–≤–∏—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ–º —Ä–æ–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –º—É–ª—å—Ç–∏—Ç–µ–Ω–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –∏ –∫–æ–Ω—Ç—Ä–æ–ª—è —Å—Ä–æ–∫–æ–≤ –¥–æ—Å—Ç—É–ø–∞.

üîó **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏**
- –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∏ –æ—Ç–∑—ã–≤ —Ä–æ–ª–µ–π —Å —É—á–µ—Ç–æ–º –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏ –∫ –∫–ª–∏–µ–Ω—Ç—É –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ä–æ–∫–∞–º–∏ –¥–µ–π—Å—Ç–≤–∏—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π
- –ü–∞–≥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π
- –ú–µ–∂–∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è –∏–∑–æ–ª—è—Ü–∏—è —á–µ—Ä–µ–∑ –∫–æ–º–±–∏–Ω–∞—Ü–∏—é client_id + app_id
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Ä–æ–ª–µ–π)

üóÉ **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö**

### –¢–∞–±–ª–∏—Ü–∞ `user_roles`
–ü–æ–ª–µ | –¢–∏–ø | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è | –û–ø–∏—Å–∞–Ω–∏–µ
-----|-----|-------------|----------
user_id | UUID | PRIMARY KEY, REFERENCES users(id) ON DELETE CASCADE | –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
role_id | UUID | PRIMARY KEY, REFERENCES roles(id) | –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ä–æ–ª–∏
client_id | UUID | PRIMARY KEY, FOREIGN KEY (client_id, role_id) REFERENCES roles(client_id, id) | –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–ª–∏–µ–Ω—Ç–∞
app_id | INT | NOT NULL | –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
assigned_by | UUID | REFERENCES users(id) | –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –Ω–∞–∑–Ω–∞—á–∏–≤—à–µ–≥–æ
expires_at | TIMESTAMPTZ |  | –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
assigned_at | TIMESTAMPTZ | NOT NULL DEFAULT NOW() | –í—Ä–µ–º—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è

### –ò–Ω–¥–µ–∫—Å—ã
- `idx_user_roles_expires` (expires_at) - –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π
- `idx_user_roles_client_user` (client_id, user_id) - –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –≤—ã–±–æ—Ä–æ–∫ –ø–æ –∫–ª–∏–µ–Ω—Ç—É –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

## üì° API –ú–µ—Ç–æ–¥—ã

### 1. –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (Assign)
```protobuf
rpc Assign(AssignRequest) returns (UserRole);

message AssignRequest {
  string user_id = 1;
  string role_id = 2;
  string client_id = 3;
  int32 app_id = 4;
  optional google.protobuf.Timestamp expires_at = 5;
  string assigned_by = 6;
}
```
**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞**
```json
{
  "user_id": "3e3f9902-ae96-4be8-94f0-762197619e06",
  "role_id": "f35c40f9-a321-425c-9e50-8371ee305c85",
  "client_id": "8268ec76-d6c2-48b5-a0e4-a9c2538b8f48",
  "app_id": 1,
  "assigned_by": "3e3f9902-ae96-4be8-94f0-762197619e06"
}
```
**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞**
```json
{
  "user_id": "3e3f9902-ae96-4be8-94f0-762197619e06",
  "role_id": "f35c40f9-a321-425c-9e50-8371ee305c85",
  "client_id": "8268ec76-d6c2-48b5-a0e4-a9c2538b8f48",
  "app_id": 1,
  "assigned_by": "3e3f9902-ae96-4be8-94f0-762197619e06",
  "expires_at": null,
  "assigned_at": {
    "seconds": "1745990516",
    "nanos": 172467000
  }
}
```
**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Ä–æ–ª–∏
- –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è (–Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –ø—Ä–æ—à–ª–æ–º)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
- –ö–∞—Å–∫–∞–¥–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ —Ä–æ–ª–∏

**–û—à–∏–±–∫–∏**

```json
{
  "code": 6,
  "message": "role assignment exists"
}
```
### 2. –û—Ç–∑—ã–≤ —Ä–æ–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (Revoke)
```protobuf
rpc Revoke(RevokeRequest) returns (RevokeResponse);

message RevokeRequest {
  string user_id = 1;
  string role_id = 2;
  string client_id = 3;
  int32 app_id = 4;
}
```
**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞**

```json
{
  "user_id": "3e3f9902-ae96-4be8-94f0-762197619e06",
  "role_id": "f35c40f9-a321-425c-9e50-8371ee305c85",
  "client_id": "8268ec76-d6c2-48b5-a0e4-a9c2538b8f48",
  "app_id": 1
}
```
**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞**

```json
{
  "success": true,
  "revoked_at": {
    "seconds": "1745990475",
    "nanos": 333580300
  }
}
```
**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏**
- –ê—Ç–æ–º–∞—Ä–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ—á–Ω–æ–µ –≤—Ä–µ–º—è –æ—Ç–∑—ã–≤–∞

### 3. –°–ø–∏—Å–æ–∫ —Ä–æ–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (ListForUser)
```protobuf
rpc ListForUser(UserRequest) returns (UserRolesResponse);

message UserRequest {
  string user_id = 1;
  string client_id = 2;
  int32 app_id = 3;
  int32 page = 4;
  int32 count = 5;
}
```
**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞**
```json
{
  "user_id": "3e3f9902-ae96-4be8-94f0-762197619e06",
  "client_id": "8268ec76-d6c2-48b5-a0e4-a9c2538b8f48",
  "app_id": 1,
  "page": 1,
  "count": 10
}
```
**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞**
```json
{
  "assignments": [
    {
      "user_id": "3e3f9902-ae96-4be8-94f0-762197619e06",
      "role_id": "f35c40f9-a321-425c-9e50-8371ee305c85",
      "client_id": "8268ec76-d6c2-48b5-a0e4-a9c2538b8f48",
      "app_id": 1,
      "assigned_by": "3e3f9902-ae96-4be8-94f0-762197619e06",
      "expires_at": null,
      "assigned_at": {
        "seconds": "1745990516",
        "nanos": 172467000
      }
    }
  ],
  "total_count": 1,
  "current_page": 1,
  "app_id": 1
}
```
**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏**
- –ü–∞–≥–∏–Ω–∞—Ü–∏—è —Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (expires_at > NOW())
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### 4. –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Ä–æ–ª—å—é (ListForRole)
```protobuf
rpc ListForRole(RoleRequest) returns (UserRolesResponse);

message RoleRequest {
  string role_id = 1;
  string client_id = 2;
  int32 app_id = 3;
  int32 page = 4;
  int32 count = 5;
}
```
**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞**

```json
{
  "role_id": "f35c40f9-a321-425c-9e50-8371ee305c85",
  "client_id": "8268ec76-d6c2-48b5-a0e4-a9c2538b8f48",
  "app_id": 1,
  "page": 1,
  "count": 10
}
```
**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞**
```json
{
  "assignments": [
    {
      "user_id": "3e3f9902-ae96-4be8-94f0-762197619e06",
      "role_id": "f35c40f9-a321-425c-9e50-8371ee305c85",
      "client_id": "8268ec76-d6c2-48b5-a0e4-a9c2538b8f48",
      "app_id": 1,
      "assigned_by": "3e3f9902-ae96-4be8-94f0-762197619e06",
      "expires_at": null,
      "assigned_at": {
        "seconds": "1745990516",
        "nanos": 172467000
      }
    }
  ],
  "total_count": 1,
  "current_page": 1,
  "app_id": 1
}
```
**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏**
- –ü–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–∞—è –≤—ã–±–æ—Ä–∫–∞
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏ —Ä–æ–ª–∏ –∫ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π

### üõ°Ô∏è –ü–æ–ª–∏—Ç–∏–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- –°—Ç—Ä–æ–≥–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è UUID –¥–ª—è –≤—Å–µ—Ö –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏ —Å—É—â–Ω–æ—Å—Ç–µ–π –∫ –æ–¥–Ω–æ–º—É –∫–ª–∏–µ–Ω—Ç—É –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É (1000)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –∏–∑–º–µ–Ω–µ–Ω–∏—è
- –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –ª–æ–≥–∞—Ö

### üîê –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –ó–∞–ø—Ä–µ—Ç –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Ä–æ–ª–µ–π
- –í–∞–ª–∏–¥–∞—Ü–∏—è —É—Ä–æ–≤–Ω—è –¥–æ—Å—Ç—É–ø–∞ –∏–Ω–∏—Ü–∏–∏—Ä—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–µ–∫—à–∏—Ö –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π (—á–µ—Ä–µ–∑ –∑–∞–¥–∞—á–∏ Cron)

### üì¶ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- –¢–∞–±–ª–∏—Ü–∞ users —Å –ø–æ–ª—è–º–∏: id (UUID), client_id (UUID), is_active (BOOL)
- –¢–∞–±–ª–∏—Ü–∞ roles —Å –ø–æ–ª—è–º–∏: id (UUID), client_id (UUID), app_id (INT), is_active (BOOL)
- PostgreSQL 14+ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º pgcrypto
- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏: pgx/v5, google.golang.org/protobuf